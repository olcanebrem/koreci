---
import { getCollection } from "astro:content";

const fetchMapData = async () => {
  const baseUrl = import.meta.env.URL || 'http://localhost:4321';
  const functionPath = '/.netlify/functions/getMapData';
  const url = `${baseUrl}${functionPath}`;

  console.log("Fetching map data from:", url);
  try {
    const response = await fetch(url, { mode: 'cors' });
    if (!response.ok) {
      throw new Error(`Failed to fetch map data: ${response.status} ${response.statusText}`);
    }
    const data = await response.json();
    console.log("Fetched config:", data);
    return data;
  } catch (error) {
    console.error("Error fetching map data:", error);
    return {
      center: { lat: 0, lng: 0 },
      zoom: 1,
      mapId: "DEMO_MAP_ID",
      apiKey: import.meta.env.GOOGLE_MAPS_API_KEY || "default_key",
    };
  }
};

let mapConfig = await fetchMapData();
const { center, zoom, mapId, apiKey } = mapConfig;
---

<section class="map-section">
  <div class="map-container">
    <gmp-map
      center={`${center.lat},${center.lng}`}
      zoom={zoom}
      map-id={mapId}
    >
      <gmp-advanced-marker
        position={`${center.lat},${center.lng}`}
        title="My location"
      ></gmp-advanced-marker>
    </gmp-map>
  </div>
  <!-- Google Maps JavaScript API'yi dinamik anahtarla yükle -->
  <script
    type="module"
    async
    src={`https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=maps,marker&v=beta`}
  ></script>
</section>

<style>
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  .map-section {
    width: 100%;
    height: 50vh; /* Tüm ekran yüksekliği */
  }

  .map-container {
    width: 100%;
    height: 100%; /* Kapsayıcı div'in yüksekliği */
  }

  gmp-map {
    width: 100%;
    height: 100%; /* Harita bileşeninin yüksekliği */
    display: block; /* Varsayılan inline davranışını engelle */
  }
</style>