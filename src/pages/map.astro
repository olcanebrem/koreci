---
// Build zamanında varsayılan değerler
const defaultMapConfig = {
  center: { lat: 41.1814, lng: 29.0385 },
  zoom: 14,
};
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Maps API with Astro</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto" crossorigin="anonymous" />
  </head>
  <body>
    <h1>Google Maps API with Astro</h1>
    <div id="map" style="width: 100%; height: 500px;"></div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const fetchMapData = async () => {
          const url = '/.netlify/functions/map';
          console.log('Fetching map data from:', url);
          try {
            const response = await fetch(url, { mode: 'cors' });
            if (!response.ok) {
              throw new Error(`Failed to fetch map data: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            console.log('Fetched data:', data);
            if (!data.mapConfig || !data.mapScript) {
              throw new Error('Invalid data structure from server');
            }
            return data;
          } catch (error) {
            console.error('Error fetching map data:', error);
            return {
              mapConfig: {
                center: { lat: 41.1814, lng: 29.0385 },
                zoom: 14,
              },
              mapScript: null,
            };
          }
        };

        const { mapConfig, mapScript } = await fetchMapData();

        if (mapScript) {
          const script = document.createElement('script');
          script.src = mapScript.match(/src="([^"]+)"/)[1];
          script.async = true;
          script.defer = true;
          script.onload = () => {
            console.log('Google Maps API loaded successfully');
            initMap(mapConfig);
          };
          script.onerror = () => {
            console.error('Failed to load Google Maps API script');
          };
          document.head.appendChild(script);
        } else {
          console.warn('No valid mapScript, skipping map initialization');
        }

        function initMap(mapConfig) {
          if (!window.google || !window.google.maps) {
            console.error('Google Maps API is not loaded');
            return;
          }
          new google.maps.Map(document.getElementById('map'), {
            center: mapConfig.center,
            zoom: mapConfig.zoom,
          });
        }
      });
    </script>
  </body>
</html>